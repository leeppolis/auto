<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Auto</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;900&family=Playfair+Display:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <link rel="include" href="https://visualize.news/remotes/footer/corporate_it.html" id="corporate" />
    <link rel="include" href="https://visualize.news/remotes/footer/legal_it.html" id="legal" />
    <link rel="stylesheet" href="https://visualize.news/remotes/footer/footer.css" type="text/css" />
    <style>
      body {
        background: #EDEAE3;
        border: 0;
        color: #2F4858;
        font-family: Montserrat, sans-serif;
        font-weight: 400;
        margin: 0;
        padding: 0;
      }

      * {
        box-sizing: border-box;
      }

      p {
        font-family: 'Playfair Display', serif;
        font-weight: 400;
        line-height: 1.5;
      }

      .wrapper {
        display: block;
        margin: 0 auto;
        width: 1320px;
      }
      
      h1 {
        font-size: 48px;
        font-weight: 800;
        margin: 40px auto;
        text-align: center;
        text-transform: uppercase;
      }

      h2 {
        font-family: 'Playfair Display', serif;
        font-size: 24px;
        font-weight: 400;
        margin: 0 auto 40px auto;
        max-width: 600px;
        text-align: center;
      }

      svg text {
        fill: #2F4858;
      }

      .header {
        alignment-baseline: middle;
        font-size: 14px;
        font-weight: 300;
      }

      .column-header {
        font-weight: 500;
        text-anchor: middle;
      }

      .row-header {
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        text-anchor: end;
      }

      .row-header.selected {
        font-weight: 700;
      }

      .summary {
        cursor: pointer;
        font-size: 12px;
        alignment-baseline: middle;
      }

      .summary.selected {
        font-weight: 700;
      }

      .summary-year {
        text-anchor: middle;
      }

      .bar-label {
        alignment-baseline: top;
        font-size: 12px;
        font-weight: 600;
        opacity: 0;
        text-anchor: middle;

      }

      .bar-label.selected {
        opacity: 1;
      }

      .bar {
        opacity: 1;
        stroke-width: 1;
      }

      .bar.selected {
        opacity: 1;
      }

      .bar-cat-shadow {
        opacity: .15;
      }

      .line-line-2,
      .line-line,
      .connector {
        fill: none;
        stroke-width: 1;
        stroke-dasharray: 4 4;
      }

      .line-line-2 {
        stroke: #0084C4;
      }

      .line-dot-ab,
      .line-dot {
        fill: #fff;
        stroke: #2F4858;
        stroke-width: 1;
      }

      .line-dot-ab {
        stroke: #0084C4;
      }



      .line-label-ab,
      .line-axis-label,
      .line-label {
        alignment-baseline: bottom;
        font-size: 12px;
      }

      .line-label-ab {
        fill: #0084C4;
      }

      .line-axis-label {
        alignment-baseline: top;
        font-size: 14px;
        font-weight: 500;
        text-anchor: middle;
      }

      .line-guide-ab,
      .line-guide {
        stroke: #2F4858;
        stroke-width: 1;
        stroke-dasharray: none;
      }

      .line-guide-ab {
        stroke: #0084C4;
        stroke-dasharray: 1 2;
      }

      .line-legend {
        align-items: center;
        display: flex;
        justify-content: center;
        margin-top: 40px;
      }

      .line-legend .legend-residente {
        color: #0084C4;
        font-size: 14px;
        padding: 0 10px;
      }

      .line-legend .legend-auto {
        font-size: 14px;
        padding: 0 10px;
      }

      #small-m {
        display: flex;
        flex-wrap: wrap;
      }

      .single {
        display: block;
        flex: 0 0 33.33%;
        height: 220px;
        margin-bottom: 20px;
        min-height: 100px;
        position: relative;
      }

      .single .container {
        bottom: 10px;
        left: 10px;
        position: absolute;
        right: 10px;
        top: 10px;
      }

      .single svg {
        left: 0;
        position: absolute;
        bottom: 0;
        z-index: 0;
      }

      .single h3 {
        font-size: 14px;
        font-weight: 400;
        left: 50%;
        margin: 0;
        position: absolute;
        top: 0;
        transform: translate3d(-50%, 0, 0);
        z-index: 1;
      }

      .single h4 {
        font-weight: 800;
        left: 50%;
        margin: 0;
        position: absolute;
        top: 30px;
        transform: translate3d(-50%, 0, 0);
        z-index: 1;
      }

      .axis-label {
        font-size: 12px;
      }

      .annotation {
        font-size: 18px;
        font-weight: 700;
        text-shadow: 1px 0 0 #EDEAE3,
          0 1px 0 #EDEAE3,
          -1px 0 0 #EDEAE3,
          0 -1px 0 #EDEAE3,
          1px 1px 0 #EDEAE3,
          -1px -1px 0 #EDEAE3,
          -1px 1px 0 #EDEAE3,
          1px -1px 0 #EDEAE3;
      }

      .numbers {
        font-size: 12px;
        font-weight: 500;
        text-shadow: 1px 0 0 #EDEAE3,
          0 1px 0 #EDEAE3,
          -1px 0 0 #EDEAE3,
          0 -1px 0 #EDEAE3,
          1px 1px 0 #EDEAE3,
          -1px -1px 0 #EDEAE3,
          -1px 1px 0 #EDEAE3,
          1px -1px 0 #EDEAE3;
      }

      header {
        margin: 160px 0;
      }

      .text {
        display: block;
        margin: 40px auto;
        width: 900px;
      }

      .text .title {
        font-size: 24px;
        font-weight: 900;
        margin: 0 0 40px 0;
        text-align: center;
        text-transform: uppercase;
      }

      .text .body {
        columns: 2;
      }

      .text .body p {
        margin: 0 0 20px 0;
      }

      .text .body p:last-child {
        margin-bottom: 0;
      }

      .text .body p strong {
        background: #FDF9F0;
        box-shadow: 0 0 0 2px #FDF9F0;;
        font-weight: 700;
      }

      .assets {
        display: block;
        height: 0;
        overflow: hidden;
        visibility: hidden;
        width: 0;
      }

      .footer {
        background: #2F4858;
        border: 0;
        color: #EDEAE3;
        display: block;
        margin-top: 80px;
        padding: 80px 0;
        width: auto;
      }

      .sources {
        display: block;
        margin: 0 auto;
        padding: 0 20px;
        width: 900px;
      }

      .cols {
        display: flex;
        margin: 0 auto;
        width: 900px;
      }

      .footer .col {
        flex: 0 0 70%;
        padding: 0 20px;
      }

      .footer .corporate {
        flex: 0 0 30%;
      }
    </style>
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>La grande corsa</h1>
        <h2>Negli ultimi anni incentivi statali e sempre pi√π stringenti limitazioni al traffico privato hanno cambiato il parco macchine dei milanesi. Usando come fonte i dati pubblici forniti dal Comune di Milano üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø abbiamo provato a vedere cosa √® cambiato, e come.</h2>
      </header>

      <div class="text">
        <h3 class="title">Auto Registrate</h3>
        <div class="body">
          <p>A partire dal 2007 al 2019 (ultimo anno disponibile per cui i dati sono disponibili), il numero di vetture private üöò intestate a residenti üë®‚Äçü¶≤ nel Comune di Milano üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø √® sceso del <strong>4,95%</strong>. Il calo √® stato leggero, dopo un picco negativo registrato <strong>tra il 2013 e il 2014</strong> (<strong>-14.922 unit√†</strong>).</p>
          <p>Nello stesso periodo <strong>i residenti sono saliti</strong> da 1.299.633 a 1.406242 unit√† (<strong>+8,2%</strong>) portando il rapporto veicoli per residente da <strong>0,55</strong> a <strong>0.49</strong>: i milanesi posseggono sempre meno auto.</p>
        </div>
      </div>
      
      <div id="line"></div>

      <div class="text">
        <h3 class="title">Evoluzione delle classi Ambientali</h3>
        <div class="body">
          <p>In un continuo tentativo di ridurre le emissioni dannose per la salute in quella che √® una delle citt√† pi√π inquinate d‚ÄôEuropa, negli ultimi anni il <strong>Comune di Milano</strong> üè¥Û†ÅßÛ†Å¢Û†Å•Û†ÅÆÛ†ÅßÛ†Åø ha imposto limitazioni sempre pi√π stringenti al traffico privato: √® del <strong>2008</strong> l‚Äôintroduzione da parte della <strong>giunta Moratti</strong> dell‚Äô<strong>Ecopass</strong>: si trattava in sostanza di un ticket da pagare per poter entrare con mezzi privati all‚Äôinterno della cerchia pi√π interna della citt√†, la cosiddetta cerchia dei navigli. Dal pagamento del ticket erano esentati i mezzi allora meno inquinanti, autoveicoli a benzina Euro 3 e 4 e veicoli Diesel Euro 4 e 5.</p>
          <p><strong>√à del 2012 l‚Äôintroduzione di Area C</strong>, che cambia le regole: divieto di accesso totale per i veicoli pi√π inquinanti e pagamento di un ticket per tutti i veicoli autorizzati. Esenti da ticket sono solo i veicoli elettrici, ciclomotori e motocicli.</p>
          <p><strong>Nel 2019 l‚Äôamministrazione Sala</strong> compie un ulteriore passo per la riduzione delle emissioni istituendo <strong>Area B</strong>: in praticamente tutto il territorio comunale <strong>√® vietata la circolazione ai mezzi pi√π inquinanti</strong>, secondo un calendario predefinito che <strong>prevede la messa al bando di tutti i veicoli Diesel nel 2030</strong> (prossima scadenza ottobre 2022 con la messa la bando dei veicoli Euro 2 a benzina e di tutti i Diesel fino a Euro 5).</p>
          <p>Queste regole hanno contribuito allo svecchiamento del parco auto circolante? Quello che notiamo (e che si vede bene nel grafico qui sotto) √® che i veicoli Euro 6 sono al 31 dicembre 2019 diventati dominanti. Che questo serva da solo a migliorare la qualit√† dell‚Äôaria, per√≤, non √® certo.</p>
          <p><em>Clicca sul nome di una classe ambientale per evidenziare la sua evoluzione nel tempo</em>.</p>
        </div>
      </div>
      <div id="parallel"></div>
      <div class="text">
        <div class="body">
          <p>Mentre la crescita esponenziale nel numero di veicoli Euro 6 non ci ha stupiti, la variaizone numerica di vecoli appartenenti ad altre categorie ambientali ci ha invece stupiti: <strong>il numero di veicoli Euro 0</strong>, ad esempio, <strong>√® rimasto sostanzialmente invariato (-7.144 unit√†)</strong> bench√© questa classe sia stata la prima a subire restrizioni, mentre <strong>il numero</strong> di veicoli pi√π efficienti (seppur ormai obsoleti: <strong>Euro 1, 2, 3</strong>) si sia <strong>pi√π che dimezzato</strong> nella stessa finestra temporale. Quale sia il motivo non ci √® noto. Possiamo speculare sul fatto che le fasce pi√π a basso reddito non possono permettersi di cambiare spesso auto, oppure supporre che gran parte di questi veicoli siano d‚Äôepoca.</p>
          <p>Nei grafici che seguono √® possibile vedere il dettaglio per ogni categoria.</p>
        </div>
      </div>

      <br /><br /><br /><br /><br /><br />
      <div id="small-m"></div>
    </div>

    <footer id="footer" class="footer vn">
      <div class="footer-wrapper">
        <div class="sources">
          <h3>Fonti</h3>
          <p><a href="https://dati.comune.milano.it/" target="_new">Portale Open Data Comune di Milano</a>, <a href="https://www.istat.it/" target="_new">Istat</a>.</p>
        </div>
        <div class="cols">
          <div class="legal col" id="footer-legal"></div>
          <div class="corporate col" id="footer-corporate"></div>
        </div>
      </div>
    </footer>

    <script>
      // Constants
      let SELECTED = '';
      const dictionary = {
        EURO6: 'Euro 6',
        EURO5: 'Euro 5',
        EURO4: 'Euro 4',
        EURO3: 'Euro 3',
        EURO2: 'Euro 2',
        EURO1: 'Euro 1',
        EURO0: 'Euro 0',
        ANI: 'Non Ident.',
        ANC: 'Non Class.',
      };
      const colors = {
        EURO6: '#79B598',
        EURO5: '#6AAB9E',
        EURO4: '#5C9AA0',
        EURO3: '#4E7B95',
        EURO2: '#40557E',
        EURO1: '#323566',
        EURO0: '#2D254D',
        ANI: '#9D4E7A',
        ANC: '#99A89E',
        NEUTRAL: '#6F8884',
        DEFAULT: '#2F4858333',
        EMPTY: '#EDEAE3',
        HIGHLIGHT: '#EDEAE3',
        TEXT: '#2F4858',
      };
      const maxBarWidth = 60;
      const barHeight = 8;
      const selectedBarHeight = 16;
      const rowHeight = 45;
      const columnWidth = 80;
      const lineChartHeight = 120;

      // Functions
      const getWidth = (value, maxValue) => {
        return Math.round(maxBarWidth * value / maxValue) || 5;
      };

      const getExtremes = (width, row, column) => {
        const half = (width / 2);
        const y = getYPos(row, false) + Math.round(barHeight / 2);
        return [[Math.ceil(getXPos(column) - half), y], [Math.floor(getXPos(column) + half), y]];
      }

      const getYPos = (line, selected = false) => {
        const bar = selected ? selectedBarHeight : barHeight;
        return (rowHeight + (line * rowHeight) + Math.round((rowHeight - bar) / 2));
      };

      const getXPos = column => (columnWidth + (column * columnWidth) + Math.round(columnWidth / 2));

      const formatNumber = (n) => d3Locale.format(',.0f')(n);

      const formatPercentage = (n) => d3Locale.format('+,.2%')(n);

      const d3Locale = d3.formatLocale({
        decimal: ',',
        thousands: '.',
        grouping: [3],
        currency: ['', '‚Ç¨']
      });

      // Select Category
      const selectCategory = (c, svgW, svgH, years, categories, data) => {
        SELECTED = c;
        parallel(svgW, svgH, years, categories, data);
      };

      // Parallel coords
      const parallel = (svgW, svgH, years, categories, data) => {
        const connectors = {};
        categories.forEach((c) => { connectors[c] = [] });
        const maxValue = 277675;
        document.querySelector('#parallel').innerHTML = '';
        const svgP = d3.select('#parallel').append('svg')
          .attr('width', svgW)
          .attr('height', svgH)
          .attr('viewbox', `0 0 ${svgW} ${svgH}`)
          .attr('preserveAspectRatio', 'xMidYMid meet');

        // Connectors Container needs to stay below everything
        const gCC = svgP.append('g')
          .attr('class', 'connectors');
        
        // Row / Column Header
        const gRH = svgP.append('g')
          .attr('class', 'headers row-headers');
        categories.forEach((c, i) => {
          gRH.append('text')
            .attr('x', columnWidth)
            .attr('dx', -15)
            .attr('y', ((i + 1) * rowHeight) + (rowHeight / 2))
            .attr('class', `header row-header ${c === SELECTED ? 'selected' : ''}`)
            .attr('id', `row-header-${c}`)
            .attr('data-category', `cat-${c}`)
            .text(dictionary[c])
            .on('click', () => { selectCategory(c, svgW, svgH, years, categories, data); });
          gRH.append('circle')
            .attr('cx', columnWidth - 5)
            .attr('cy', ((i + 1) * rowHeight) + (rowHeight / 2))
            .attr('r', 3)
            .attr('fill', colors[c]);
        });

        const gCH = svgP.append('g')
          .attr('class', 'headers columns-headers');
        years.forEach((c, i) => {
          gCH.append('text')
            .attr('x', getXPos(i))
            .attr('y', rowHeight / 2)
            .attr('class', 'header column-header')
            .attr('id', `column-header-${c}`)
            .attr('data-category', `year-${c}`)
            .text(c);
        });

        // Years
        years.forEach((y, i) => {
          const barSources = data.auto[y].sort((a, b) => b.numero - a.numero);
          const xPos = getXPos(i);
          const gYB = svgP.append('g')
            .attr('class', `year year-${y}`);
          
          barSources.forEach((b,l) => {
            const width = (b.numero > 0) ? getWidth(b.numero, maxValue) : 2;
            gYB.append('rect')
              .attr('x', xPos)
              .attr('y', getYPos(l, b.classe === SELECTED))
              .attr('width', width)
              .attr('height', b.classe === SELECTED ? selectedBarHeight : barHeight)
              .attr('data-category', `cat-${b.classe} cat-${y}`)
              .attr('transform',`translate(-${Math.round(width / 2)})`)
              .attr('stroke', colors[b.classe])
              .attr('fill', b.classe === SELECTED ? colors[b.classe] : `url('#fill')`)
              .attr('class', `bar bar-year-${y} bar-cat-${b.classe} ${(b.numero > 0) ? '' : 'bar-cat-shadow'} ${b.classe === SELECTED ? 'selected' : ''}`)
              .style('cursor', 'pointer')
              .on('click', () => { selectCategory(b.classe, svgW, svgH, years, categories, data); });;
            gYB.append('text')
              .attr('x', xPos)
              .attr('y', getYPos(l, b.classe === SELECTED))
              .attr('dy', -4)
              .attr('data-category', `cat-${b.classe} cat-${y}`)
              .attr('class', `bar-label ${b.classe === SELECTED ? 'selected' : ''}`)
              .text(`${formatNumber(b.numero)} ${y === '2007' ? ' veicoli' : ''}`);
            connectors[b.classe].push(getExtremes(width, l, i));
          });
        });

        // Connectors
        categories.forEach((c) => {
          const gCCS = gCC.append('g')
            .attr('class', `connector connector-${c}`)
            .attr('data-category', `cat-${c}`);
          connectors[c].forEach((d, i) => {
            if (i > 0) {
              gCCS.append('line')
                .attr('x1', connectors[c][i -1][1][0])
                .attr('y1', connectors[c][i -1][1][1])
                .attr('x2', d[0][0])
                .attr('y2', d[0][1])
                .attr('stroke', colors[c])
                .attr('class', `connector ${c === SELECTED ? 'selected' : ''}`);
            } else {
              gCCS.append('line')
                .attr('x1', columnWidth)
                .attr('y1', d[0][1])
                .attr('x2', d[0][0])
                .attr('y2', d[0][1])
                .attr('stroke', colors[c])
                .attr('class', `connector ${c === SELECTED ? 'selected' : ''}`);
            }
          });
          gCCS.append('line')
            .attr('x1', svgW - columnWidth)
            .attr('y1', connectors[c][connectors[c].length - 1][1][1])
            .attr('x2', connectors[c][connectors[c].length - 1][1][0])
            .attr('y2', connectors[c][connectors[c].length - 1][1][1])
            .attr('stroke', colors[c])
            .attr('class', `connector ${c === SELECTED ? 'selected' : ''}`);
        });

        // Summaries
        const gSY = svgP.append('g')
          .attr('class', 'summary-categories');
        const lastYear = data.auto[years[years.length - 1]].sort((a, b) => b.numero - a.numero);
        lastYear.forEach((y, i) => {
          gSY.append('text')
            .attr('x', svgW - columnWidth)
            .attr('dx', 15)
            .attr('y', ((i + 1) * rowHeight) + (rowHeight / 2))
            .attr('class', `summary summary-category ${y.classe === SELECTED ? 'selected' : ''}`)
            .text(`${dictionary[y.classe]}`)
            .on('click', () => { selectCategory(y.classe, svgW, svgH, years, categories, data); });
          gRH.append('circle')
            .attr('cx', svgW - columnWidth + 5)
            .attr('cy', ((i + 1) * rowHeight) + (rowHeight / 2))
            .attr('r', 3)
            .attr('fill', colors[y.classe]);
        });
      };
      
      // Lollipop
      const lollipop = (svgW, svgH, years, total, persone) => {
        const svgL = d3.select('#line')
          .append('svg')
          .attr('width', svgW)
          .attr('height', lineChartHeight)
          .attr('viewbox', `0 0 ${svgW} 200`)
          .attr('preserveAspectRatio', 'xMidYMid meet');

        const gL = svgL.append('g');
        const gG = svgL.append('g');
        const gD = svgL.append('g');
        const gLB = svgL.append('g');

        let maxValue = Number.MIN_SAFE_INTEGER;
        let minValue = Number.MAX_SAFE_INTEGER;
        years.forEach((y, i) => {
          maxValue = total[y] > maxValue ? total[y] : maxValue;
          minValue = total[y] < minValue ? total[y] : minValue;
          maxValue = persone[y] > maxValue ? persone[y] : maxValue;
          minValue = persone[y] < minValue ? persone[y] : minValue;
        });
        const yScale = d3.scaleLinear()
          .domain([ minValue, maxValue ])
          .range([lineChartHeight - 40, 20]);
        let path = [`M${getXPos(0)} ${yScale(total[years[0]])}`];
        let path2 = [`M${getXPos(0)} ${yScale(persone[years[0]])}`];
        years.forEach((y, i) => {
          const xp = getXPos(i);
          const yp = yScale(total[y]);
          const yab = yScale(persone[y]);
          path.push(`L${xp} ${yp}`);
          path2.push(`L${xp} ${yab}`);

          gD.append('circle')
            .attr('cx', xp)
            .attr('cy', yp)
            .attr('r', 5)
            .attr('stroke', colors.DEFAULT)
            .attr('fill', colors.EMPTY)
            .attr('class','line-dot');

          gD.append('circle')
            .attr('cx', xp)
            .attr('cy', yab)
            .attr('r', 5)
            .attr('stroke', colors.DEFAULT)
            .attr('fill', colors.EMPTY)
            .attr('class','line-dot-ab');

          gLB.append('text')
            .attr('x', xp)
            .attr('y', yp)
            .attr('dy', -8)
            .attr('class','line-label')
            .attr('text-anchor', `${(i === years.length - 1 ? 'start' : (i === 0 ? 'end' : 'middle'))}`)
            .text(`${(i === 0 ? 'üöò' : '')} ${formatNumber(total[y])} ${(i === years.length - 1 ? 'üöò' : '')}`);

          gLB.append('text')
            .attr('x', xp)
            .attr('y', yab)
            .attr('dy', -8)
            .attr('class','line-label-ab')
            .attr('text-anchor', `${(i === years.length - 1 ? 'start' : (i === 0 ? 'end' : 'middle'))}`)
            .text(`${(i === 0 ? 'üë®‚Äç' : '')} ${formatNumber(persone[y])} ${(i === years.length - 1 ? 'üë®‚Äç' : '')}`);

          gLB.append('text')
            .attr('x', xp)
            .attr('y', lineChartHeight - 20)
            .attr('dy', 20)
            .attr('class','line-axis-label')
            .text(y);

          gG.append('line')
            .attr('x1', xp)
            .attr('x2', xp)
            .attr('y1', lineChartHeight - 20)
            .attr('y2', yp)
            .attr('stroke', colors.DEFAULT)
            .attr('class', 'line-guide');

          gG.append('line')
            .attr('x1', xp)
            .attr('x2', xp)
            .attr('y1', lineChartHeight - 20)
            .attr('y2', yab)
            .attr('stroke', colors.DEFAULT)
            .attr('class', 'line-guide-ab');
        });
        gL.append('path')
          .attr('d', path.join(','))
          .attr('stroke', colors.NEUTRAL)
          .attr('class', 'line-line');
        gL.append('path')
          .attr('d', path2.join(','))
          .attr('stroke', colors.NEUTRAL)
          .attr('class', 'line-line-2');

        const legend = d3.select('#line')
          .append('div')
            .attr('class', 'line-legend');
        
          legend.append('div')
            .attr('class', 'legend-residente')
            .text('üë®‚Äçü¶≤ Residenti');
        
        legend.append('div')
          .attr('class', 'legend-auto')
          .text('üöò Veicoli');
      };
      
      // Load Data
      d3.json('./data/data.json')
        .then((data) => {
          console.log(data);
          const years = Object.keys(data.auto).sort((a,b) => a - b);
          const categories = data.auto[years[0]].sort((a, b) => b.numero - a.numero).map(c => c.classe);
          const svgW = columnWidth * (years.length + 2);
          const svgH = rowHeight * (categories.length + 1);
          

          const total = {};
          years.forEach((y) => {
            total[y] = data.auto[y].reduce((acc, d) => acc + d.numero, 0);
          });

          lollipop(svgW, svgH, years, total, data.persone);
          parallel(svgW, svgH, years, categories, data);

          // Small Multiples
          (() => {
            const smallMultiples = {};
            let maxMax = Number.MIN_SAFE_INTEGER;
            let minMin = Number.MAX_SAFE_INTEGER;
            const chartHeight = 220;
            const margin = 80;
            const vMargin = 40;
            years.forEach((y, i) => {
              data.auto[y].forEach((c, i) => {
                if (!smallMultiples[c.classe]) {
                  smallMultiples[c.classe] = [];
                }
                smallMultiples[c.classe].push(c.numero);
                if (c.numero > maxMax) {
                  maxMax = c.numero;
                }
                if (c.numero < minMin) {
                  minMin = c.numero;
                }
              });
            });
            console.log(smallMultiples, minMin, maxMax);
            const classes = Object.keys(smallMultiples);
            classes.sort().reverse();
            console.log(classes);

            const wrapper = d3.select('#small-m');
            classes.forEach((c) => {
              const div = wrapper.append('div')
                .attr('class', `single single-${c}`)
                .attr('id', c);
              const container = div.append('div')
                .attr('class', 'container');
              container.append('h3')
                .text(dictionary[c]);
              // const increase = ((smallMultiples[c][smallMultiples[c].length - 1]) / smallMultiples[c][0]) - 1;
              // container.append('h4')
              //   .attr('class', 'increase')
              //   .text(formatPercentage(increase));



              const scaleX = d3.scaleLinear()
                .range([margin, 420 - (margin)])
                .domain([0, 12]);
              const scaleY = d3.scaleLinear()
                .range([chartHeight - (vMargin), vMargin])
                .domain([minMin, maxMax]);

              const area = d3.area()
                .x(p => p.x)
                .y1(p => p.y)
                .y0(chartHeight - vMargin)
                .curve(d3.curveCatmullRom.alpha(0.5));
              
              const line = d3.line()
                .x(p => p.x)
                .y(p => p.y)
                .curve(d3.curveCatmullRom.alpha(0.5));
              const data = smallMultiples[c].map((d, i) => ({ x: scaleX(i), y: scaleY(d)}));

              const svgS = container.append('svg')
                .attr('width', 420)
                .attr('height', chartHeight)
                .attr('viewbox', `0 0 420 180`)
                .attr('preserveAspectRatio', 'xMidYMid meet');
              svgS.append('line')
                .attr('x1', margin)
                .attr('x2', 420 - (margin))
                .attr('y1', chartHeight - vMargin)
                .attr('y2', chartHeight - vMargin)
                .attr('stroke', colors.NEUTRAL)
                .attr('fill', 'none');
              svgS.append('line')
                .attr('x1', margin)
                .attr('x2', margin)
                .attr('y1', chartHeight - vMargin)
                .attr('y2', chartHeight - vMargin + 10)
                .attr('stroke', colors.NEUTRAL)
                .attr('fill', 'none');
              svgS.append('line')
                .attr('x1', 420 - (margin))
                .attr('x2', 420 - (margin))
                .attr('y1', chartHeight - vMargin)
                .attr('y2', chartHeight - vMargin + 10)
                .attr('stroke', colors.NEUTRAL)
                .attr('fill', 'none');
              svgS.append('text')
                .attr('x', 420 - (margin))
                .attr('y', chartHeight - vMargin + 20)
                .attr('class', 'axis-label')
                .attr('text-anchor', 'end')
                .attr('alignment-baseline', 'top')
                .text('2019');
              svgS.append('text')
                .attr('x', margin)
                .attr('y', chartHeight - vMargin + 20)
                .attr('class', 'axis-label')
                .attr('text-anchor', 'start')
                .attr('alignment-baseline', 'top')
                .text('2007');
              svgS.append('text')
                .attr('x', 210)
                .attr('y', chartHeight - vMargin + 20)
                .attr('class', 'axis-label')
                .attr('text-anchor', 'middle')
                .attr('alignment-baseline', 'top')
                .text('‚Üê Anni ‚Üí');

              const min = smallMultiples[c][0];
              const max = smallMultiples[c][smallMultiples[c].length - 1];

              let string = (min < max) ? `+${formatNumber(Math.round(max / min))}√ó` : `-${formatNumber(Math.round(min / max))}√ó`;

              console.log(scaleY(min), scaleY(max));
              if (string === '-1√ó' || string === '+1√ó') {
                string = '‚âÉ';
              }
              const ypos = (Math.abs(scaleY(min) - scaleY(max)) > 15) ? scaleY(d3.mean([min, max])) : scaleY(d3.mean([min, max])) - 15;
              console.log(scaleY(min), scaleY(max), '=', ypos );


              svgS.append('line')
                .attr('x1', (margin))
                .attr('x2', 420 - (margin))
                .attr('y1', scaleY(min))
                .attr('y2', scaleY(min))
                .attr('stroke', colors.NEUTRAL)
                .attr('stroke-width', 1)
                .attr('stroke-dasharray', '1 1')
                .attr('fill', 'none');

              svgS.append('line')
                .attr('x1', (margin))
                .attr('x2', 420 - (margin))
                .attr('y1', scaleY(max))
                .attr('y2', scaleY(max))
                .attr('stroke', colors.NEUTRAL)
                .attr('stroke-width', 1)
                .attr('stroke-dasharray', '2 1')
                .attr('fill', 'none');

              svgS.append('path')
                .attr('d', area(data))
                .attr('class', `sm-area sm-area-${c}`)
                .attr('id', `sm-area-${c}`)
                .attr('stroke', 'none')
                .attr('fill', 'url(#fill)');
              svgS.append('path')
                .attr('d', line(data))
                .attr('class', `sm-line sm-line-${c}`)
                .attr('id', `sm-line-${c}`)
                .attr('stroke', colors[c])
                .attr('stroke-width', 2)
                .attr('fill', 'none');

              svgS.append('text')
                .attr('x', 210)
                .attr('y', ypos)
                .attr('class', 'annotation')
                .attr('text-anchor', 'middle')
                .attr('alignment-baseline', 'middle')
                .text(string);

              svgS.append('text')
                .attr('x', data[0].x)
                .attr('y', data[0].y)
                .attr('dx', -5)
                .attr('class', 'numbers')
                .attr('text-anchor', 'end')
                .attr('alignment-baseline', 'middle')
                .text(formatNumber(smallMultiples[c][0]));

              svgS.append('text')
                .attr('x', data[0].x)
                .attr('y', data[0].y)
                .attr('class', 'numbers')
                .attr('text-anchor', 'start')
                .attr('alignment-baseline', 'middle')
                .text('Veicoli');

              svgS.append('text')
                .attr('x', data[data.length - 1].x)
                .attr('dx', 5)
                .attr('y', data[data.length - 1].y)
                .attr('class', 'numbers')
                .attr('text-anchor', 'start')
                .attr('alignment-baseline', 'middle')
                .text(formatNumber(smallMultiples[c][smallMultiples[c].length - 1]));

            });
          })();

        });

        fetch(document.querySelector('#corporate').getAttribute('href'))
          .then(response => response.text())
          .then(content => {
            document.querySelector('#footer-corporate').innerHTML =content;
          });
        fetch(document.querySelector('#legal').getAttribute('href'))
          .then(response => response.text())
          .then(content => {
            document.querySelector('#footer-legal').innerHTML =content;
          });
    </script>
    <div class="assets">
      <svg>
        <defs>
          <pattern
            id="fill"
            width="3px"
            height="3px"
            patternUnits="userSpaceOnUse"
            patternContentUnits="userSpaceOnUse"
            viewBox="0 0 60 60"
            preserveAspectRatio="none"
            patternTransform="rotate(-45)"
          >
            <line
              x1="0"
              x2="90"
              y1="60"
              y2="60"
              stroke-width="10"
              stroke="#6F8884"
            />
          </pattern>
        </defs>
      </svg>
    </div>
  </body>
</html>
